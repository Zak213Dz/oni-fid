<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte de Fidélité</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    .logo {
      margin-top: 10px;
    }
    .infos {
      margin: 20px 0;
      font-size: 18px;
    }
    .carte {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      max-width: 240px;
      margin: 20px auto;
    }
    .case {
      width: 50px;
      height: 50px;
      background: white;
      border-radius: 5px;
    }
    .rempli img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .qr img {
      margin-top: 15px;
      width: 120px;
    }
  </style>
</head>
<body>
  <div class="logo"><img src="https://i.ibb.co/BrBkKV7/logo.png" width="60"></div>
  <div class="infos">
    <div><strong>Nom :</strong> <span id="nom"></span></div>
    <div><strong>Prénom :</strong> <span id="prenom"></span></div>
    <div><strong>ID :</strong> <span id="idClient"></span></div>
    <div><strong>Montant cumulé :</strong> <span id="montant"></span> €</div>
    <div><strong>Menus offerts :</strong> <span id="menus"></span></div>
  </div>
  <div class="carte" id="cases"></div>
  <div class="qr"><img id="qr" src=""></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const clientId = urlParams.get('id');

    fetch("https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0J_iakEUYtcP-RPRlVNTBvlPPJ8mqsz7hnPWFSNl-9TihVe9pYwH00kroVBIEF2JrqkqtYZWLmUos/pub?gid=1144651952&single=true&output=csv
")
      .then(res => res.text())
      .then(data => {
        const json = JSON.parse(data.substring(47).slice(0, -2));
        const rows = json.table.rows;

        const client = rows.find(r => r.c[4] && r.c[4].v === clientId);
        if (!client) {
          document.body.innerHTML = "<h2 style='color:white'>Client introuvable</h2>";
          return;
        }

        const nom = client.c[0]?.v || "";
        const prenom = client.c[1]?.v || "";
        const tel = client.c[2]?.v || "";
        const points = parseInt(client.c[5]?.v || 0);
        const montant = parseFloat(client.c[6]?.v || 0).toFixed(2);
        const menus = parseInt(client.c[8]?.v || 0);

        document.getElementById("nom").textContent = nom;
        document.getElementById("prenom").textContent = prenom;
        document.getElementById("idClient").textContent = clientId;
        document.getElementById("montant").textContent = montant;
        document.getElementById("menus").textContent = menus;

        const container = document.getElementById("cases");
        for (let i = 0; i < 10; i++) {
          const div = document.createElement("div");
          div.className = "case" + (i < points ? " rempli" : "");
          if (i < points) {
            const img = document.createElement("img");
            img.src = "https://i.ibb.co/BrBkKV7/logo.png";
            div.appendChild(img);
          }
          container.appendChild(div);
        }

        const qr = document.getElementById("qr");
        qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://zak213dz.github.io/oni-fid/carte.html?id=${clientId}`;
      });
  </script>
</body>
</html>
